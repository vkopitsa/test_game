<!DOCTYPE HTML>
<html>
   <head>
   
        <script type="text/javascript" src="/closure-library/closure/goog/base.js"></script>

        <script type="text/javascript" src="/protobuf/js/binary/constants.js"></script>
        <script type="text/javascript" src="/protobuf/js/binary/utils.js"></script>
        <script type="text/javascript" src="/protobuf/js/binary/arith.js"></script>
        <script type="text/javascript" src="/protobuf/js/binary/encoder.js"></script>
        <script type="text/javascript" src="/protobuf/js/binary/decoder.js"></script>
        <script type="text/javascript" src="/protobuf/js/map.js"></script>
        <script type="text/javascript" src="/protobuf/js/binary/writer.js"></script>
        <script type="text/javascript" src="/protobuf/js/binary/reader.js"></script>
        <script type="text/javascript" src="/protobuf/js/message.js"></script>

        <script type="text/javascript" src="/pb.js"></script>

        <script type = "text/javascript">
            (function() {
                //var ProtoBuf = dcodeIO.ProtoBuf;
                //var builder = ProtoBuf.loadJsonFile("message.json");
                
                // Let us open a web socket
                var ws = new WebSocket("ws://127.0.0.1:8080/ws");

                //var Message = builder.build("Message");
                //var Hello = builder.build("Hello");

                var ggg = new proto.messages.Message();
                ggg.setType(proto.messages.Message.Type.HELLO);
                //var mmm = new proto.messages.Message();
                
                ws.onopen = function() {
                    ws.binaryType = "arraybuffer";

                    //debugger;

                    //var data = Hello.encode({name: "Worl"}).buffer;
                    //var message = Message.encode({type: 1, data: data}).buffer;
                    ws.send(ggg.serializeBinary());
                };
                
                ws.onmessage = function (event) { 
                    var message = proto.messages.Message.deserializeBinary(event.data);
                    //console.log(message.getType());
                };
                
                ws.onclose = function() { 
                    
                    // websocket is closed.
                    //alert("Connection is closed..."); 
                    //data.textContent = 'Connection closed';
                    console.log("Connection is closed...");
                };

                setInterval(() => {
                    if (ws.readyState !== ws.CLOSED) {
                        //var data = Hello.encode({name: "Worl"}).buffer;
                        var data = new proto.messages.Hello();
                        data.setName("Worl");
                        //var message = Message.encode({type: 1, data: data}).buffer;
                        var message = new proto.messages.Message();
                        message.setType(proto.messages.Message.Type.HELLO);
                        message.setData(data.serializeBinary());

                        //console.log(data, "data");
                        //console.log(message, "message");

                        ws.send(message.serializeBinary());
                    }
                }, 1000/30);
                
            })();
        </script>
   </head>
   
   <body>
    <div id="fileData"></div>
   </body>
</html>